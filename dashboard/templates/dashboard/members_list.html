{% extends "dashboard/dashboard_base.html" %}

{% block title %}会員一覧{% endblock %}
{% block content_title %}会員一覧{% endblock %}

{% block content %}
<div class="admin-admins">
  <div class="card">
    <div class="table-wrap">
    <div class="admin-admins members-page">
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>ユーザー名</th>
            <th>メール</th>
            <th>最終ログイン</th>
            <th>ステータス</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="{% if not u.is_active %}inactive{% endif %}">
            <td>{{ u.id }}</td>
            <td>
              {{ u.username }}{% if u == request.user %} <span class="subtle">(自分)</span>{% endif %}
                {% if not u.is_active %}<span class="subtle">(退会済)</span>{% endif %}
            </td>
            <td>{{ u.email }}</td>
            <td style="text-align:center;">{{ u.last_login|date:"Y/m/d H:i" }}</td>
            <td style="text-align:center;">
            {% if u.is_active %}
                <span class="badge badge-active">会員</span>
            {% else %}
                <span class="badge badge-inactive">退会済</span>
            {% endif %}
            </td>
            <td class="actions">
              <div class="action-row">
                {% if request.user.is_superuser or request.user.is_staff %}
                  <a class="btn btn-edit" href="{% url 'dashboard:member_edit' u.pk %}">編集</a>
                  {% if u.is_active %}
                    <form method="post" action="{% url 'dashboard:withdraw_member' u.pk %}"
                          onsubmit="return confirm('このユーザーを退会処理します。よろしいですか？');">
                      {% csrf_token %}
                      <button class="btn btn-danger" type="submit">退会</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'dashboard:reactivate_member' u.pk %}"
                          onsubmit="return confirm('このユーザーを再開します。よろしいですか？');">
                      {% csrf_token %}
                      <button class="btn btn-restart" type="submit">再開</button>
                    </form>
                  {% endif %}
                {% else %}
                  {% if u == request.user %}
                    <a class="btn btn-edit" href="{% url 'dashboard:member_edit' u.pk %}">編集</a>
                    <button class="btn btn-disabled" type="button" disabled>退会</button>
                  {% else %}
                    <button class="btn btn-disabled" type="button" disabled>編集</button>
                    <button class="btn btn-disabled" type="button" disabled>退会</button>
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="subtle">該当するユーザーはいません。</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if is_paginated %}
        <div class="pagination" style="margin-top:16px; display:flex; justify-content:center; gap:8px; align-items:center;">

          {% if page_obj.has_previous %}
            <a class="btn" href="?page={{ page_obj.previous_page_number }}">前へ</a>
          {% else %}
            <button class="btn btn-disabled" type="button" disabled>前へ</button>
          {% endif %}

          <span class="subtle">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="btn" href="?page={{ page_obj.next_page_number }}">次へ</a>
          {% else %}
            <button class="btn btn-disabled" type="button" disabled>次へ</button>
          {% endif %}
        </div>
      {% endif %}
    </div>
    </div>
  </div>
</div>
{% endblock %}
