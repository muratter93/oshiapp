{% extends "dashboard/dashboard_base.html" %}

{% block title %}ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}
{% block content_title %}ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}
{% block content_meta %}
<p class="subtle">{{ user.username }} ã•ã‚“ï¼ˆãƒ­ã‚°ã‚¤ãƒ³: {{ user.last_login|date:"Yå¹´mæœˆdæ—¥ H:i" }}ï¼‰</p>
{% endblock %}

{% block content %}

<p>åœ°å›³ã®ç·´ç¿’</p>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  #map {
    height: 65vh;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,.12);
  }
  .jump-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* ä¸Š3ã¤ / ä¸‹3ã¤ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ */
    gap: .5rem;
    margin-top: .75rem;
  }
  .jump-buttons button {
    padding: .6rem .8rem;
    border-radius: .75rem;
    border: 1px solid #e5e7eb;
    background: #fff;
    cursor: pointer;
    transition: background .2s;
    font-weight: 600;
  }
  .jump-buttons button:hover {
    background: #f3f4f6;
  }
</style>

<div id="map"></div>

<!-- â–¼ åœ°å›³æ“ä½œç”¨ãƒœã‚¿ãƒ³ï¼ˆä¸Š3Ã—ä¸‹3Ã—ä¸‹3 ã®3è¡Œï¼‰ -->
<div class="jump-buttons">
  <!-- 1è¡Œç›® -->
  <button onclick="resetView()">ğŸ—ºï¸ å…¨ä½“ãƒãƒƒãƒ—è¡¨ç¤º</button>
  <button onclick="showTriangle()">ğŸ”º ä¸‰è§’å½¢ã‚’è¡¨ç¤º</button>
  <button onclick="toggleTriangleSpin()">â¯ ä¸‰è§’å½¢ãã‚‹ãã‚‹</button>

  <!-- 2è¡Œç›® -->
  <button onclick="flyToSpot('jyouyama')">ğŸ’ åŸå±±å‹•ç‰©åœ’</button>
  <button onclick="flyToSpot('chausuyama')">ğŸ˜ èŒ¶è‡¼å±±å‹•ç‰©åœ’</button>
  <button onclick="flyToSpot('suzaka')">ğŸ¦˜ é ˆå‚å¸‚å‹•ç‰©åœ’</button>

  <!-- 3è¡Œç›® -->
  <button onclick="openStreetView('jyouyama')">ğŸš¶ åŸå±±å‹•ç‰©åœ’ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼</button>
  <button onclick="openStreetView('chausuyama')">ğŸš¶ èŒ¶è‡¼å±±å‹•ç‰©åœ’ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼</button>
  <button onclick="openStreetView('suzaka')">ğŸš¶ é ˆå‚å¸‚å‹•ç‰©åœ’ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼</button>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // â–¼ å„å‹•ç‰©åœ’ã®è©³ç´°æƒ…å ±
  const spots = [
    {
      id: 'jyouyama',
      name: 'ğŸ’åŸå±±å‹•ç‰©åœ’',
      // Leafletåœ°å›³ç”¨
      lat: 36.66490806254121,
      lng: 138.1942988606473,
      zoom: 16,
      // ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ç”¨
      sv_lat: 36.665244588523024,
      sv_lng: 138.1935118468303,
      sv_heading: 130,
      address: 'ã€’380-0802 é•·é‡çœŒé•·é‡å¸‚ä¸Šæ¾ï¼’ä¸ç›®ï¼‘âˆ’ï¼‘ï¼™',
      tel: '026-233-0586'
    },
    {
      id: 'chausuyama',
      name: 'ğŸ˜èŒ¶è‡¼å±±å‹•ç‰©åœ’',
      lat: 36.58530392097484,
      lng: 138.11518754155875,
      zoom: 16,
      sv_lat: 36.583904,
      sv_lng: 138.114083,
      sv_heading: 0,
      address: 'ã€’388-8016 é•·é‡çœŒé•·é‡å¸‚ç¯ ãƒäº•æœ‰æ—…ï¼•ï¼—ï¼âˆ’ï¼‘',
      tel: '026-293-5167'
    },
    {
      id: 'suzaka',
      name: 'ğŸ¦˜é ˆå‚å¸‚å‹•ç‰©åœ’',
      lat: 36.6423500355432,
      lng: 138.31111727750795,
      zoom: 16,
      sv_lat: 36.643277,
      sv_lng: 138.311711,
      sv_heading: 180,
      address: 'ã€’382-0028 é•·é‡çœŒé ˆå‚å¸‚è‡¥ç«œï¼’ä¸ç›®ï¼”âˆ’ï¼˜',
      tel: '026-245-1770'
    }
  ];

  // â–¼ ä¸‰è§’å½¢ï¼ˆ3åœ’ã‚’çµã¶ãƒãƒªã‚´ãƒ³ï¼šå…ƒã®åº§æ¨™ï¼‰
  const triangleCoords = spots.map(s => [s.lat, s.lng]);
  const triangle = L.polygon(triangleCoords, {
    color: '#2563eb',     // ç·šã®è‰²ï¼ˆé’ï¼‰
    weight: 3,            // ç·šã®å¤ªã•
    fillColor: '#bfdbfe', // å¡—ã‚Šã¤ã¶ã—è‰²ï¼ˆæ·¡ã„é’ï¼‰
    fillOpacity: 0.25     // å¡—ã‚Šã¤ã¶ã—ã®é€æ˜åº¦
  });
  // åˆæœŸçŠ¶æ…‹ã§ã¯ addTo(map) ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰è¡¨ç¤ºï¼‰

  // â–¼ å›è»¢ç”¨ã®å¤‰æ•°
  let rotationAngle = 0;      // ç¾åœ¨ã®è§’åº¦ï¼ˆåº¦æ•°ï¼‰
  let triangleSpinId = null;  // requestAnimationFrame ID

  // ä¸‰è§’å½¢ã®ä¸­å¿ƒï¼ˆé‡å¿ƒï¼‰ã‚’äº‹å‰ã«è¨ˆç®—
  const triangleCenter = [
    (triangleCoords[0][0] + triangleCoords[1][0] + triangleCoords[2][0]) / 3,
    (triangleCoords[0][1] + triangleCoords[1][1] + triangleCoords[2][1]) / 3
  ];

  // 1ç‚¹ã‚’å›è»¢ã•ã›ã‚‹é–¢æ•°
  function rotatePoint(center, point, angleDeg) {
    const angle = angleDeg * Math.PI / 180;  // åº¦ â†’ ãƒ©ã‚¸ã‚¢ãƒ³
    const lat = point[0] - center[0];
    const lng = point[1] - center[1];

    return [
      center[0] + (lat * Math.cos(angle) - lng * Math.sin(angle)),
      center[1] + (lat * Math.sin(angle) + lng * Math.cos(angle))
    ];
  }

  // ä¸‰è§’å½¢ã‚’æŒ‡å®šè§’åº¦ã«å›è»¢ã•ã›ã‚‹
  function setTriangleRotation(angleDeg) {
    const rotated = triangleCoords.map(p =>
      rotatePoint(triangleCenter, p, angleDeg)
    );
    triangle.setLatLngs(rotated);
  }

  // è‡ªå‹•å›è»¢1ã‚¹ãƒ†ãƒƒãƒ—
  function spinStep() {
    rotationAngle = (rotationAngle + 100) % 360;  // å›è»¢é€Ÿåº¦ï¼ˆ0.5Â°ãšã¤ï¼‰
    setTriangleRotation(rotationAngle);
    triangleSpinId = requestAnimationFrame(spinStep);
  }

  // å›è»¢ã‚¹ã‚¿ãƒ¼ãƒˆ
  function startTriangleSpin() {
    if (!map.hasLayer(triangle)) {
      triangle.addTo(map);  // è¡¨ç¤ºã•ã‚Œã¦ãªã‹ã£ãŸã‚‰è¡¨ç¤º
    }
    if (triangleSpinId !== null) {
      return;               // æ—¢ã«å›è»¢ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
    }
    spinStep();
  }

  // å›è»¢ã‚¹ãƒˆãƒƒãƒ—
  function stopTriangleSpin() {
    if (triangleSpinId !== null) {
      cancelAnimationFrame(triangleSpinId);
      triangleSpinId = null;
    }
    rotationAngle = 0;
    triangle.setLatLngs(triangleCoords); // å…ƒã®å½¢ã«æˆ»ã™
  }

  // ãƒœã‚¿ãƒ³ç”¨ãƒˆã‚°ãƒ«
  function toggleTriangleSpin() {
    if (triangleSpinId === null) {
      startTriangleSpin();
    } else {
      stopTriangleSpin();
    }
  }

  // â–¼ åœ°å›³ä½œæˆ
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
  const markers = [];
  spots.forEach((s) => {
    const popupContent = `
      <b>${s.name}</b><br>
      ${s.address}<br>
      â˜ ${s.tel}
    `;
    const marker = L.marker([s.lat, s.lng]).addTo(map).bindPopup(popupContent);
    marker.on('click', () => {
      map.flyTo([s.lat, s.lng], s.zoom, { duration: 0.6 });
      marker.openPopup();
    });
    markers.push(marker);
  });

  // å…¨ä½“ãƒ“ãƒ¥ãƒ¼ã‚’è¨ˆç®—
  const group = L.featureGroup(markers);
  const fullBounds = group.getBounds().pad(0.3);
  map.fitBounds(fullBounds);

  // â–¼ å€‹åˆ¥ã®åœ’ã«ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆã“ã®ã¨ãå›è»¢ã‚‚ä¸‰è§’å½¢ã‚‚æ­¢ã‚ã‚‹ï¼‰
  function flyToSpot(id) {
    const s = spots.find(x => x.id === id);
    if (!s) return;

    // å›è»¢åœæ­¢ï¼†ä¸‰è§’å½¢éè¡¨ç¤º
    stopTriangleSpin();
    if (map.hasLayer(triangle)) {
      map.removeLayer(triangle);
    }

    map.flyTo([s.lat, s.lng], s.zoom, { duration: 0.6 });
    const idx = spots.indexOf(s);
    markers[idx].openPopup();
  }

  // ğŸŒ å…¨ä½“ãƒãƒƒãƒ—ã«æˆ»ã‚‹ï¼ˆã“ã“ã§ã¯ä¸‰è§’å½¢ã‚‚å›è»¢ã‚‚æ­¢ã‚ã‚‹ï¼‰
  function resetView() {
    map.flyToBounds(fullBounds, { duration: 0.8 });
    map.closePopup();

    // å›è»¢åœæ­¢ï¼†ä¸‰è§’å½¢éè¡¨ç¤º
    stopTriangleSpin();
    if (map.hasLayer(triangle)) {
      map.removeLayer(triangle);
    }
  }

  // ğŸ”º ä¸‰è§’å½¢ã‚’è¡¨ç¤ºï¼ˆå…¨ä½“ãƒãƒƒãƒ—ï¼‹ä¸‰è§’å½¢ã®ã¿è¡¨ç¤ºï¼‰
  function showTriangle() {
    map.flyToBounds(fullBounds, { duration: 0.8 });
    map.closePopup();

    // å›è»¢ã¯ã•ã›ãšã€å½¢ã ã‘è¡¨ç¤º
    stopTriangleSpin();
    if (!map.hasLayer(triangle)) {
      triangle.addTo(map);
    }
  }

  // ğŸš¶ ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’é–‹ã
  function openStreetView(id) {
    const s = spots.find(x => x.id === id);
    if (!s) return;

    const lat = s.sv_lat ?? s.lat;
    const lng = s.sv_lng ?? s.lng;
    const heading = s.sv_heading ?? 0; // æŒ‡å®šãªã‘ã‚Œã°åŒ—å‘ã

    const url =
      `https://www.google.com/maps/@?api=1&map_action=pano` +
      `&viewpoint=${lat},${lng}` +
      `&heading=${heading}&pitch=0&fov=80`;

    window.open(url, '_blank');
  }
</script>

{% endblock %}
