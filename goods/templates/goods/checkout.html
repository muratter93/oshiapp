{% extends "common/base.html" %} 
{% load static %}

{% block title %}住所確認{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/goods.css' %}">
{% endblock %}

{% block content %}
<div id="checkout-main_center">
  <h2>住所確認ページ</h2>

  <!-- エラーメッセージ -->
  <div id="error-container" class="checkout-error-message" style="display:none;"></div>

  <form method="post" action="{% url 'goods:confirm_exchange' %}" id="address-form">
      {% csrf_token %}

      <h3>配送先の選択</h3>
      <label>
          <input type="radio" name="address_option" value="registered" checked> 登録済み住所を使用
      </label><br>
      <label>
          <input type="radio" name="address_option" value="new"> 新しい住所を使用
      </label>

      <!-- 登録済み住所 -->
      <div id="registered-address" style="margin-top:10px;">
          <p><strong>名前:</strong> {{ member.name }}</p>
          <p><strong>郵便番号:</strong> {{ member.postal_code }}</p>
          <p><strong>住所:</strong> {{ member.address }}</p>
          <p><strong>電話番号:</strong> {{ member.phone }}</p>
      </div>

      <!-- 新しい住所フォーム -->
      <div id="new-address" class="address-form" style="display:none;">
          <label>名前
              <input type="text" name="new_name">
          </label>
          <label>郵便番号
              <input type="text" name="new_postal_code" id="postal_code" placeholder="例：1234567(ハイフン不要)">
          </label>
          <label>住所
              <input type="text" name="new_address" id="address" placeholder="都道府県・市区町村・番地など">
          </label>
          <label>電話番号
              <input type="text" name="new_phone" placeholder="例：09012345678（ハイフン不要）">
          </label>
      </div>

      <h3>カート内容</h3>
      <ul class="checkout-cart">
          {% for item in cart_items %}
              <li>{{ item.goods.name }} × {{ item.quantity }}個（{{ item.get_required_stanning_points }}スタポ）</li>
          {% endfor %}
      </ul>

      <p><strong>合計スタポ:</strong> {{ total_stanning }}</p>
      <p><strong>現在のウォレット残高:</strong> {{ wallet.stanning_point_balance }}スタポ</p>

      <button type="submit" class="checkout-btn">交換を確定する</button>
  </form>

  <a href="{% url 'goods:cart_view' %}" class="back-link">← カートに戻る</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const registered = document.getElementById("registered-address");
    const newAddress = document.getElementById("new-address");
    const radios = document.querySelectorAll('input[name="address_option"]');
    const form = document.getElementById("address-form");
    const errorContainer = document.getElementById("error-container");

    // --- 新しい住所フォームの表示切り替え ---
    radios.forEach(radio => {
        radio.addEventListener("change", function() {
            if (this.value === "new") {
                newAddress.style.display = "block";
                registered.style.display = "none";
            } else {
                newAddress.style.display = "none";
                registered.style.display = "block";
            }
        });
    });

    // --- 郵便番号→住所自動補完（ZipCloud API） ---
    const postalInput = document.getElementById("postal_code");
    postalInput.addEventListener("blur", function() {
        const postal = this.value.replace(/[^0-9]/g, ""); // 数字以外除去
        if (postal.length === 7) {
            fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postal}`)
            .then(response => response.json())
            .then(data => {
                if (data.results) {
                    const result = data.results[0];
                    const address = result.address1 + result.address2 + result.address3;
                    document.getElementById("address").value = address;
                } else {
                    alert("住所が見つかりませんでした。");
                }
            })
            .catch(() => alert("住所検索に失敗しました。"));
        }
    });

    // --- 入力チェック（エラーメッセージ表示） ---
    form.addEventListener("submit", function(event) {
        errorContainer.style.display = "none";
        errorContainer.innerHTML = "";
        const inputs = form.querySelectorAll("input");
        inputs.forEach(i => i.classList.remove("checkout-error"));

        const selected = document.querySelector('input[name="address_option"]:checked').value;
        if (selected === "new") {
            const name = form.new_name.value.trim();
            const postal = form.new_postal_code.value.trim();
            const address = form.new_address.value.trim();
            const phone = form.new_phone.value.trim();
            const errors = [];

            if (!name) { errors.push("名前を入力してください。"); form.new_name.classList.add("checkout-error"); }
            if (!postal) { errors.push("郵便番号を入力してください。"); form.new_postal_code.classList.add("checkout-error"); }
            else if (!/^\d{7}$/.test(postal)) { errors.push("郵便番号は7桁の数字で入力してください。"); form.new_postal_code.classList.add("checkout-error"); }
            if (!address) { errors.push("住所を入力してください。"); form.new_address.classList.add("checkout-error"); }
            if (!phone) { errors.push("電話番号を入力してください。"); form.new_phone.classList.add("checkout-error"); }
            else if (!/^\d+$/.test(phone)) { errors.push("電話番号は数字のみで入力してください。"); form.new_phone.classList.add("checkout-error"); }

            if (errors.length > 0) {
                event.preventDefault();
                errorContainer.innerHTML = errors.join("<br>");
                errorContainer.style.display = "block";
                window.scrollTo({ top: 0, behavior: "smooth" });
            }
        }
    });
});
</script>
{% endblock %}
