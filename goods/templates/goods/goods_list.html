{% extends "common/base.html" %}
{% load static %}

{% block title %}グッズ交換{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/goods.css' %}">
<style>
  /* 認証誘導モーダル */
  #authModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.35);
    z-index: 1000;
  }
  #authModal .modal_content {
    background: #fff;
    width: 90%;
    max-width: 420px;
    margin: 10vh auto;
    padding: 16px;
    border-radius: 8px;
  }
  #authModal h3 { margin-top: 0; }
  #authModal div { text-align: right; margin-top: 16px; }
  #authModal a, #authModal button {
    margin-left: 8px;
    padding: 6px 12px;
    border-radius: 6px;
    text-decoration: none;
  }
  #authModal a.signup { background: #6b7280; color: #fff; }
  #authModal a.login { background: #2563eb; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div id="goods_main_center">
  <h1>グッズ交換一覧</h1>

  <div class="goods_grid">
    {% for goods in goods_list %}
      <div class="goods_card">
        <a href="{% url 'goods:goods_detail' goods.id %}">
          <div class="goods_img_wrapper">
            {% if goods.image %}
              <img src="{{ goods.image.url }}" alt="{{ goods.name }}" class="goods_img">
            {% else %}
              <img src="{% static 'img/no_image.png' %}" alt="{{ goods.name }}" class="goods_img">
            {% endif %}
          </div>
        </a>

        <h3>{{ goods.name }}</h3>
        <p>必要スタポ：{{ goods.required_stanning_points }} pt</p>

        {% if goods.stock == 0 %}
          <button class="goods_btn disabled" disabled>在庫なし</button>
        {% else %}
          {% if goods.stock <= 10 %}
            <p class="low-stock">残りわずか！</p>
          {% endif %}

          {% if user.is_authenticated %}
            <a href="{% url 'goods:add_to_cart' goods.id %}" class="goods_btn">交換</a>
          {% else %}
            <button class="goods_btn exchange_btn" data-goods="{{ goods.id }}">交換</button>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <a href="{% url 'goods:order_history' %}">交換履歴を見る</a>
  <a href="{% url 'donation:donate' %}">寄付する</a>
</div>

<!-- 認証誘導モーダル -->
<div id="authModal">
  <div class="modal_content">
    <h3>会員登録が必要です</h3>
    <p>グッズを交換するにはログインまたは新規登録をしてください。</p>
    <div>
      <button id="authCancelBtn">キャンセル</button>
      <a href="{% url 'accounts:signup' %}?next={% url 'goods:goods_list' %}" class="signup">新規登録</a>
      <a href="{% url 'accounts:login' %}?next={% url 'goods:goods_list' %}" class="login">ログイン</a>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const modal = document.getElementById("authModal");
    const cancelBtn = document.getElementById("authCancelBtn");

    document.querySelectorAll(".exchange_btn").forEach(btn => {
      btn.addEventListener("click", function() {
        modal.style.display = "block";
      });
    });

    cancelBtn.addEventListener("click", function() {
      modal.style.display = "none";
    });

    // モーダルの外側クリックで閉じる
    window.addEventListener("click", function(e) {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    });
  });
</script>
{% endblock %}
